{% extends 'core/base.html' %}
{% block title %}Cart{% endblock %}

{% block content %}
<div class="cart-container">
    <div class="cart-card">
        <div class="cart-header">
            <h2 class="cart-title">Your Shopping Cart</h2>
            <div class="cart-count">{{ items|length }} item{% if items|length != 1 %}s{% endif %}</div>
        </div>

        {% if items %}
        <div class="cart-items">
            {% for item in items %}
            <div class="cart-item" data-item-id="{{ item.id }}">
                <div class="item-image">
                    {% if item.outfit.image %}
                    <img src="{{ item.outfit.image.url }}" alt="{{ item.outfit.name }}" loading="lazy">
                    {% else %}
                    <div class="image-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    {% endif %}
                </div>

                <div class="item-details">
                    <h3 class="item-name">{{ item.outfit.name }}</h3>
                    <div class="item-price">Ksh{{ item.outfit.price }}</div>

                    <div class="quantity-controls">
                        <button class="quantity-btn minus" data-id="{{ item.id }}" data-action="decrease">âˆ’</button>
                        <span class="quantity" id="quantity-{{ item.id }}">{{ item.quantity }}</span>
                        <button class="quantity-btn plus" data-id="{{ item.id }}" data-action="increase">+</button>
                    </div>
                </div>

                <div class="item-subtotal">
                    <span id="subtotal-{{ item.id }}">Ksh{{ item.total_price }}</span>
                    <button class="remove-item" data-item-id="{{ item.id }}" title="Remove item">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="cart-summary">
            <div class="summary-row">
                <span>Subtotal</span>
                <span id="cart-subtotal">Ksh{{ subtotal }}</span>
            </div>
            <div class="summary-row">
                <span>Shipping</span>
                <span>Free</span>
            </div>
            <div class="summary-row total">
                <span>Total</span>
                <span id="cart-total">Ksh{{ total }}</span>
            </div>

            <a href="{% url 'checkout' %}" class="checkout-btn">
                Proceed to checkout
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                    <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
            </a>
        </div>
        {% else %}
        <div class="empty-cart">
            <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="10" cy="20.5" r="1"></circle>
                    <circle cx="18" cy="20.5" r="1"></circle>
                    <path d="M2.5 2.5h3l2.7 12.4a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6l1.6-8.4H7.1"></path>
                </svg>
            </div>
            <h3>Your cart is empty</h3>
            <p>Start shopping to add items to your cart</p>
            <a href="{% url 'outfit_list' %}" class="shop-btn">Browse Outfits</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Handle quantity buttons (increase/decrease)
    document.querySelectorAll(".quantity-btn").forEach(button => {
        button.addEventListener("click", function () {
            const itemId = this.dataset.id;
            const action = this.dataset.action;
            const url = `/cart/${action}/${itemId}/`;

            fetch(url, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Update quantity and subtotal
                    document.querySelector(`#quantity-${itemId}`).innerText = data.quantity;
                    document.querySelector(`#subtotal-${itemId}`).innerText = `Ksh${data.subtotal}`;
                    // Update cart summary
                    if (data.cart_total !== undefined) {
                        document.getElementById("cart-subtotal").textContent = `Ksh${data.cart_total}`;
                        document.getElementById("cart-total").textContent = `Ksh${data.cart_total}`;
                    }
                    // Remove item if quantity is 0
                    if (data.quantity === 0) {
                        document.querySelector(`.cart-item[data-item-id="${itemId}"]`).remove();
                        // Update cart count
                        const cartCount = document.querySelector(".cart-count");
                        const currentCount = parseInt(cartCount.textContent) - 1;
                        cartCount.textContent = `${currentCount} item${currentCount !== 1 ? 's' : ''}`;
                        // Show empty cart message if no items remain
                        if (currentCount === 0) {
                            document.querySelector(".cart-items").style.display = "none";
                            document.querySelector(".cart-summary").style.display = "none";
                            document.querySelector(".empty-cart").style.display = "block";
                        }
                    }
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert(`An error occurred: ${err.message}`);
            });
        });
    });

    // Handle remove buttons
    document.querySelectorAll(".remove-item").forEach(button => {
        button.addEventListener("click", function () {
            const itemId = this.getAttribute("data-item-id");

            fetch(`/cart/remove/${itemId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Remove the item block
                    const cartItem = document.querySelector(`.cart-item[data-item-id="${itemId}"]`);
                    if (cartItem) {
                        cartItem.remove();
                    }
                    // Update cart summary
                    if (data.cart_total !== undefined) {
                        document.getElementById("cart-subtotal").textContent = `Ksh${data.cart_total}`;
                        document.getElementById("cart-total").textContent = `Ksh${data.cart_total}`;
                    }
                    // Update cart count
                    const cartCount = document.querySelector(".cart-count");
                    const currentCount = parseInt(cartCount.textContent) - 1;
                    cartCount.textContent = `${currentCount} item${currentCount !== 1 ? 's' : ''}`;
                    // Show empty cart message if no items remain
                    if (currentCount === 0) {
                        document.querySelector(".cart-items").style.display = "none";
                        document.querySelector(".cart-summary").style.display = "none";
                        document.querySelector(".empty-cart").style.display = "block";
                    }
                } else {
                    alert(`Error: ${data.error}`);
                }
            })
            .catch(err => {
                console.error("Error:", err);
                alert(`An error occurred: ${err.message}`);
            });
        });
    });

    // CSRF token helper
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}